{% extends 'base.html' %}
{% load static %}
{% block nav-buttons %}
<button class="btn btn-outline-success ml-auto mr-1"
    type="button" data-toggle="collapse" data-target="#barplot"
    aria-expanded="false" aria-controls="barplot">Case distribution plots</button>
{% endblock %}

{% load crispy_forms_tags %}

{% block content %}
<div class="card collapse p-3" 
    id="barplot" 
    data-log-id={{ log_id }}
    data-get-barplot-url="{% url 'demo:get_barplot_case' %}">
    <div class="card-body">
        <h5 class="card-title">Case distribution plots</div>
        <div class="row-sm" id="barplot_case_length"></div>
        <div class="row-sm" id="barplot_unique_activity"></div>
    </div>
</div>
<div class="row">
    <div class="col-md-3">
        <h5 class="card-title">Choose case to replay:</h5>
        <hr class="mt-0 mb-4">
        <form enctype="multipart/form-data" method="post">
            {% csrf_token %}
            {{ case_select_form | crispy }}
            <button class="btn btn-primary" type="submit">Update</button>
        </form>
        <h5 class="card-title mt-5">Case events:</h5>
        <table
            id="table-event"
            class="table-borderless table-sm"
            data-toggle="table"
            data-height="250"
            data-url="{% url 'demo:json_event_stream' event_id %}"
            data-row-style='RowStyle'>
            <thead>
                <tr>
                    <th data-field='index'>Event index</th>
                    <th data-field='activity_label'>Activity</th>
                    <th data-field='current' data-visible="false"></th>
                </tr>
            </thead>
        </table>
        <button 
            class="btn btn-primary mt-3" 
            id="next_event"
            onclick="replay_next_event()">
            Next event</button>
    </div>
    <div 
        class="col-md-10" 
        id="replay_detail" 
        data-event-id="{{ event_id }}"
        data-replay-next-event-url="{% url 'demo:replay_next_event' %}">
    </div>
</div>
{% endblock %}
{% block js %}
    <script>
        $(document).ready(function() {
            var get_barplot_url = $('div #barplot').attr('data-get-barplot-url');
            var log_id = $('div #barplot').attr('data-log-id');
            var data = {
                'csrfmiddlewaretoken': Cookies.get('csrftoken'),
                'log_id': log_id,
            };

            $.ajax({
                url: get_barplot_url,
                data: data,
                dataType: 'json',
                success: function(data) {
                    var case_length_url = data.barplot_case_length_url;
                    var case_length_name = data.barplot_case_length_name;
                    var unique_activity_url = data.barplot_case_unique_activity_url;
                    var unique_activity_name = data.barplot_case_unique_activity_name;

                    info_msg = 'Bar plot success: case_length_url: ' + case_length_url;
                    info_msg = info_msg + ' unique_activity_url: ' + unique_activity_url;
                    console.log(info_msg);

                    var case_length_image = '<img class="img-fluid" src="' + case_length_url;
                    case_length_image = case_length_image + '" alt="Case length distribution">';
                    $('div #barplot_case_length').append(case_length_image);

                    var unique_activity_image = '<img class="img-fluid" src="' + unique_activity_url;
                    unique_activity_image = unique_activity_image + '" alt="Unique activity distribution">';
                    $('div #barplot_unique_activity').append(unique_activity_image);
                }
            });

        });
    </script>
    <script>
        function RowStyle(row, index) {
            if (row.current) {
                return {
                    css: {
                        'background-color': '#99ff33',
                    }
                };
            }
            else {
                return {};
            }
        }
    </script>
    <!--Script to replay next event-->
    <script>
        function replay_next_event() {
            var event_id = $("div #replay_detail").attr('data-event-id');
            var url = $("div #replay_detail").attr('data-replay-next-event-url');

            info_msg = 'Calling url: ' + url + ' to replay next event after event: ' + event_id;
            console.log(info_msg);

            $.ajax({
                url: url,
                data: {
                    'csrfmiddlewaretoken': Cookies.get('csrftoken'),
                    'event_id': event_id,
                },
                dataType: 'json',
                success: function(data) {
                    info_msg = 'Got next event id: ' + data.event_id;
                    console.log(info_msg);

                    // update replay_detail
                    var replay_detail = $("#replay_detail");
                    replay_detail.attr("data-event-id", data.event_id);

                    // update replay detail children here
                }
            });
        }
    </script>
{% endblock %}
